<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Compilation of Working Documentation for Final Project Proposal Brainstorm/Other Ideas &amp;ldquo;Hands Off&amp;rdquo; Color Tracking 3D MIDI controller with ESP32 Cam For my final project, I aim to build a midi controller where a person can change instrument sounds just by holding their hand up or horizontally or down. Because of the &amp;ldquo;hands off&amp;rdquo; concept, the musician/producer doesn&amp;rsquo;t have to rely on a bulky piece of hardware. The project could incorporate different sensors such as light, movement, and visual sensors (such as a camera).'><title>WIP Final Project</title>

<link rel='canonical' href='https://juhye-m.github.io/ps70/posts/wip-final-proj/'>

<link rel="stylesheet" href="/ps70/scss/style.min.css"><meta property='og:title' content='WIP Final Project'>
<meta property='og:description' content='Compilation of Working Documentation for Final Project Proposal Brainstorm/Other Ideas &amp;ldquo;Hands Off&amp;rdquo; Color Tracking 3D MIDI controller with ESP32 Cam For my final project, I aim to build a midi controller where a person can change instrument sounds just by holding their hand up or horizontally or down. Because of the &amp;ldquo;hands off&amp;rdquo; concept, the musician/producer doesn&amp;rsquo;t have to rely on a bulky piece of hardware. The project could incorporate different sensors such as light, movement, and visual sensors (such as a camera).'>
<meta property='og:url' content='https://juhye-m.github.io/ps70/posts/wip-final-proj/'>
<meta property='og:site_name' content='JuHye Mun'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:published_time' content='2021-04-13T12:44:06-07:00'/><meta property='article:modified_time' content='2021-04-13T12:44:06-07:00'/>
<meta name="twitter:title" content="WIP Final Project">
<meta name="twitter:description" content="Compilation of Working Documentation for Final Project Proposal Brainstorm/Other Ideas &amp;ldquo;Hands Off&amp;rdquo; Color Tracking 3D MIDI controller with ESP32 Cam For my final project, I aim to build a midi controller where a person can change instrument sounds just by holding their hand up or horizontally or down. Because of the &amp;ldquo;hands off&amp;rdquo; concept, the musician/producer doesn&amp;rsquo;t have to rely on a bulky piece of hardware. The project could incorporate different sensors such as light, movement, and visual sensors (such as a camera).">
    </head>
    <body class="article-page keep-sidebar">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            localStorage.setItem(colorSchemeKey, "auto");
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.body.dataset.scheme = 'dark';
        } else {
            document.body.dataset.scheme = 'light';
        }
    })();
</script><div class="container main-container flex on-phone--column compact ">
            <aside class="sidebar left-sidebar sticky">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header class="site-info">
        
            <figure class="site-avatar">
                
                    
                    
                    
                        
                        <img src="/ps70/img/avatar_hue776a334b902d7828bf5c7a8aa11ccb3_243528_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                

                
                    <span class="emoji">ðŸ‘¾</span>
                
            </figure>
        
        <h1 class="site-name"><a href="https://juhye-m.github.io/ps70/">JuHye Mun</a></h1>
        <h2 class="site-description">Blog for PS70</h2>
    </header>

    <ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/ps70/'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/ps70/about'>
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        

        
    </ol>
</aside>

            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <h2 class="article-title">
        <a href="/ps70/posts/wip-final-proj/">WIP Final Project</a>
    </h2>

    <footer class="article-time">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <time class="article-time--published">Apr 13, 2021</time>
    </footer></div>
</header>

    <section class="article-content">
    <h1 id="compilation-of-working-documentation-for-final-project">Compilation of Working Documentation for Final Project</h1>
<h2 id="proposal">Proposal</h2>
<h2 id="brainstormother-ideas">Brainstorm/Other Ideas</h2>
<h4 id="hands-off-color-tracking-3d-midi-controller-with-esp32-cam">&ldquo;Hands Off&rdquo; Color Tracking 3D MIDI controller with ESP32 Cam</h4>
<p>For my final project, I aim to build a midi controller where a person can change instrument sounds just by holding their hand up or horizontally or down. Because of the &ldquo;hands off&rdquo; concept, the musician/producer doesn&rsquo;t have to rely on a bulky piece of hardware. The project could incorporate different sensors such as light, movement, and visual sensors (such as a camera). This product would simulate a two-dimensional plane, where each axis represents some customizable parameter to an instrument. For example, the axes can control sustain and release:</p>
<p><figure style="flex-grow: 120; flex-basis: 288px">
		<a href="/ps70/posts/wip-final-proj/logicaxis.png" data-size="700x583"><img src="/ps70/posts/wip-final-proj/logicaxis.png"
				srcset="/ps70/posts/wip-final-proj/logicaxis_hu94242b88b05813c924ac438472cc9b0a_30407_480x0_resize_box_2.png 480w, /ps70/posts/wip-final-proj/logicaxis_hu94242b88b05813c924ac438472cc9b0a_30407_1024x0_resize_box_2.png 1024w"
				width="700"
				height="583"
				loading="lazy"
				alt="Photo from Logic Pro User Guide">
		</a>
		
		<figcaption>Photo from Logic Pro User Guide</figcaption>
		
	</figure></p>
<p>As a college student and musician whose two homes are thousands of miles away, I often find it challengeing to create music when the instruments I&rsquo;m used to hide on the other side of the country. This brought me to wanting a digital instrument that was portable in design and flexible in musicality.</p>
<p>A greater goal would be to intregrate my technology into popular DAWs (Digital Audio Workstations) and their tools (such as Alchemy in Logic Pro), so that it is more widely accessible to musicians.</p>
<p><figure style="flex-grow: 296; flex-basis: 712px">
		<a href="/ps70/posts/wip-final-proj/alchemy.jpg" data-size="1163x392"><img src="/ps70/posts/wip-final-proj/alchemy.jpg"
				srcset="/ps70/posts/wip-final-proj/alchemy_hu64795f107992f9cf3d6c13ce413a8c9b_48384_480x0_resize_q75_box.jpg 480w, /ps70/posts/wip-final-proj/alchemy_hu64795f107992f9cf3d6c13ce413a8c9b_48384_1024x0_resize_q75_box.jpg 1024w"
				width="1163"
				height="392"
				loading="lazy"
				alt="Photo by Rounik Sethi on macProVideo">
		</a>
		
		<figcaption>Photo by Rounik Sethi on macProVideo</figcaption>
		
	</figure></p>
<p>I wanted to customize the OpenCV program so that it outputs a music note when the program detects that the object is in a certain location. There is a lot to build open this, such as changing pitch as the colored object moves across the screen. This could be a cool instrument achieved with just a glove! MIDI could be integrated as well.</p>
<p>I did more research for what I could explore with the ESP32 webcam, and came across this <a class="link" href="https://pgaleone.eu/tensorflow/opencv/playerctl/2020/03/26/facectrl-control-media-player-face/"  target="_blank" rel="noopener"
    >Python program that plays music when it detects your face</a>.</p>
<h4 id="msp-juce-integrations">MSP, Juce Integrations</h4>
<pre><code>- [ ] Max MSP
- [ ] Juce
- [ ] https://forum.juce.com/t/hardware-control-via-serial-usb/39346/5 
- [ ] vcv rack https://vcvrack.com/
</code></pre>
<h4 id="velostat-flex-sensor">Velostat (flex sensor)</h4>
<p>Deprecates quickly.</p>
<h2 id="initial-research">Initial Research</h2>
<p>I also did further research on the overall technology I am implementing. IAC stands for Inter-Application Communitation. The IAC Driver is Apple&rsquo;s default MIDI device that you can use to communicate to Applications (such as Logic Pro X) that I use here. I must set up IAC drivers &ndash; it doesn&rsquo;t set itself up automatically.</p>
<p>MIDI refers to a protocol for communication, digital interface, and electrical connectors  &ndash; formally called Musical Instrument Digital Interface. It was developed in the 80s. The reason why MIDI devices do not produce audio on their own is because MIDI does not provide actual audio signals. It is simply data and information that does not include audio signals.</p>
<p>For my code, I used the MIDImessage Arduino function. It takes as parameters (noteON, pitch, velocity). These are decimal values, which are converted into binary. More info <a class="link" href="https://www.instructables.com/What-is-MIDI/"  target="_blank" rel="noopener"
    >here</a>!</p>
<h2 id="midi--simple-button">MIDI &amp; Simple Button</h2>
<p>First, in terms of the physical aspect of my product, I needed to think about how I want to implement input. There were different ideas I had, including buttons and copper tape as well as a potentiometer. I plan on using a potentiometer to represent paraneter input. One simple example of this is to control volume. For the keys of the keyboard, since I would need at least an octave (12 keys) that are also flexible and workable with, I decided so far that the best way to do this would be with copper tape. I looked back on the week on capacitance, where we used copper tape, and believe I can make a similar set up where I have one piece of copper tape and another piece that the key would touch when you press it.</p>
<p>Here was my TODO list that I made for the week for final project next-steps.
<img src="todo.png" alt="todo"  /></p>
<p>Before I worked on all of these elements, however, I needed to work on the software side as well. In order to do that and to make sure that this idea would work, I set up a simple button control ciruit.
Because I wanted to avoid buying more parts including midi input and midi wires, I researched how I could use alternative ways to do this project. I found a few blogs that used &ldquo;Hairless MIDI&rdquo; which is a software that allowed access to the Arduino serial monitor and converted the data to midi. Unfortunately, it turns out that Hairless midi stopped working on the new Mac OS!! This was extrememely disappointing. However, I found a github repository that created a python version of Hairless midi. It was just one man who wrote this up, and there was little documentation.</p>
<p>The code for this is quite long.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-py" data-lang="py"><span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> queue
<span style="color:#f92672">import</span> rtmidi
<span style="color:#f92672">import</span> serial
<span style="color:#f92672">import</span> threading
<span style="color:#f92672">import</span> logging
<span style="color:#f92672">import</span> sys
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> argparse

<span style="color:#75715e"># Serial MIDI Bridge</span>
<span style="color:#75715e"># Ryan Kojima</span>


parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser(description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Serial MIDI bridge&#34;</span>)

parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--serial_name&#34;</span>, type<span style="color:#f92672">=</span>str, required <span style="color:#f92672">=</span> True, help <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Serial port name. Required&#34;</span>)
parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--baud&#34;</span>, type<span style="color:#f92672">=</span>int, default<span style="color:#f92672">=</span><span style="color:#ae81ff">115200</span>, help <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;baud rate. Default is 115200&#34;</span>)
parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--midi_in_name&#34;</span>, type<span style="color:#f92672">=</span>str, default <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;IAC Bus 1&#34;</span>)
parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--midi_out_name&#34;</span>, type<span style="color:#f92672">=</span>str, default <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;IAC Bus 2&#34;</span>)
parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;--debug&#34;</span>, action <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;store_true&#34;</span>, help <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Print incoming / outgoing MIDI signals&#34;</span>)

args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()

thread_running <span style="color:#f92672">=</span> True

<span style="color:#75715e"># Arguments</span>
serial_port_name <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>serial_name <span style="color:#75715e">#&#39;/dev/cu.SLAB_USBtoUART&#39;</span>
serial_baud <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>baud
given_port_name_in <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>midi_in_name <span style="color:#75715e">#&#34;IAC Bus 1&#34;</span>
given_port_name_out <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>midi_out_name <span style="color:#75715e">#&#34;IAC Bus 2&#34;</span>

<span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>debug:
    logging<span style="color:#f92672">.</span>basicConfig(level <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>DEBUG)
<span style="color:#66d9ef">else</span>:
    logging<span style="color:#f92672">.</span>basicConfig(level <span style="color:#f92672">=</span> logging<span style="color:#f92672">.</span>INFO)

midi_ready <span style="color:#f92672">=</span> False
midiin_message_queue <span style="color:#f92672">=</span> queue<span style="color:#f92672">.</span>Queue()
midiout_message_queue <span style="color:#f92672">=</span> queue<span style="color:#f92672">.</span>Queue()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_midi_length</span>(message):
    <span style="color:#66d9ef">if</span> len(message) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">100</span>
    opcode <span style="color:#f92672">=</span> message[<span style="color:#ae81ff">0</span>]
    <span style="color:#66d9ef">if</span> opcode <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0xf4</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">if</span> opcode <span style="color:#f92672">in</span> [ <span style="color:#ae81ff">0xf1</span>, <span style="color:#ae81ff">0xf3</span> ]:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span>
    <span style="color:#66d9ef">if</span> opcode <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xf2</span>:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">3</span>
    <span style="color:#66d9ef">if</span> opcode <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xf0</span>:
        <span style="color:#66d9ef">if</span> message[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xf7</span>:
            <span style="color:#66d9ef">return</span> len(message)

    opcode <span style="color:#f92672">=</span> opcode <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xf0</span>
    <span style="color:#66d9ef">if</span> opcode <span style="color:#f92672">in</span> [ <span style="color:#ae81ff">0x80</span>, <span style="color:#ae81ff">0x90</span>, <span style="color:#ae81ff">0xa0</span>, <span style="color:#ae81ff">0xb0</span>, <span style="color:#ae81ff">0xe0</span> ]:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">3</span>
    <span style="color:#66d9ef">if</span> opcode <span style="color:#f92672">in</span> [ <span style="color:#ae81ff">0xc0</span>, <span style="color:#ae81ff">0xd0</span> ]:
        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span>

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">100</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">serial_writer</span>():
    <span style="color:#66d9ef">while</span> midi_ready <span style="color:#f92672">==</span> False:
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)
    <span style="color:#66d9ef">while</span> thread_running:
        <span style="color:#66d9ef">try</span>:
            message <span style="color:#f92672">=</span> midiin_message_queue<span style="color:#f92672">.</span>get(timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.4</span>)
        <span style="color:#66d9ef">except</span> queue<span style="color:#f92672">.</span>Empty:
            <span style="color:#66d9ef">continue</span>
        logging<span style="color:#f92672">.</span>debug(message)
        value <span style="color:#f92672">=</span> bytearray(message)
        ser<span style="color:#f92672">.</span>write(value)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">serial_watcher</span>():
    receiving_message <span style="color:#f92672">=</span> []
    running_status <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

    <span style="color:#66d9ef">while</span> midi_ready <span style="color:#f92672">==</span> False:
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.1</span>)

    <span style="color:#66d9ef">while</span> thread_running:
        data <span style="color:#f92672">=</span> ser<span style="color:#f92672">.</span>read()
        <span style="color:#66d9ef">if</span> data:
            <span style="color:#66d9ef">for</span> elem <span style="color:#f92672">in</span> data:
                receiving_message<span style="color:#f92672">.</span>append(elem)
            <span style="color:#75715e">#Running status</span>
            <span style="color:#66d9ef">if</span> len(receiving_message) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
                <span style="color:#66d9ef">if</span> (receiving_message[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0xf0</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
                    running_status <span style="color:#f92672">=</span> receiving_message[<span style="color:#ae81ff">0</span>]
                <span style="color:#66d9ef">else</span>:
                    receiving_message <span style="color:#f92672">=</span> [ running_status, receiving_message[<span style="color:#ae81ff">0</span>] ]

            message_length <span style="color:#f92672">=</span> get_midi_length(receiving_message)
            <span style="color:#66d9ef">if</span> message_length <span style="color:#f92672">&lt;=</span> len(receiving_message):
                logging<span style="color:#f92672">.</span>debug(receiving_message)
                midiout_message_queue<span style="color:#f92672">.</span>put(receiving_message)
                receiving_message <span style="color:#f92672">=</span> []



<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">midi_input_handler</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, port):
        self<span style="color:#f92672">.</span>port <span style="color:#f92672">=</span> port
        self<span style="color:#f92672">.</span>_wallclock <span style="color:#f92672">=</span> time<span style="color:#f92672">.</span>time()

    <span style="color:#66d9ef">def</span> __call__(self, event, data<span style="color:#f92672">=</span>None):
        message, deltatime <span style="color:#f92672">=</span> event
        self<span style="color:#f92672">.</span>_wallclock <span style="color:#f92672">+=</span> deltatime
        <span style="color:#75715e">#logging.debug(&#34;[%s] @%0.6f %r&#34; % (self.port, self._wallclock, message))</span>
        midiin_message_queue<span style="color:#f92672">.</span>put(message)



<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">midi_watcher</span>():
    <span style="color:#66d9ef">global</span> midi_ready, thread_running

    midiin <span style="color:#f92672">=</span> rtmidi<span style="color:#f92672">.</span>MidiIn()
    midiout <span style="color:#f92672">=</span> rtmidi<span style="color:#f92672">.</span>MidiOut()
    available_ports_out <span style="color:#f92672">=</span> midiout<span style="color:#f92672">.</span>get_ports()
    available_ports_in <span style="color:#f92672">=</span> midiin<span style="color:#f92672">.</span>get_ports()
    logging<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;IN : &#39;&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;,&#39;&#34;</span><span style="color:#f92672">.</span>join(available_ports_in) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span>)
    logging<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;OUT : &#39;&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;,&#39;&#34;</span><span style="color:#f92672">.</span>join(available_ports_out) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#39;&#34;</span>)
    logging<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Hit ctrl-c to exit&#34;</span>)

    port_index_in <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
    port_index_out <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">for</span> i, s <span style="color:#f92672">in</span> enumerate(available_ports_in):
        <span style="color:#66d9ef">if</span> given_port_name_in <span style="color:#f92672">in</span> s:
            port_index_in <span style="color:#f92672">=</span> i
    <span style="color:#66d9ef">for</span> i, s <span style="color:#f92672">in</span> enumerate(available_ports_out):
        <span style="color:#66d9ef">if</span> given_port_name_out <span style="color:#f92672">in</span> s:
            port_index_out <span style="color:#f92672">=</span> i

    <span style="color:#66d9ef">if</span> port_index_in <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;MIDI IN Device name is incorrect. Please use listed device name.&#34;</span>)
    <span style="color:#66d9ef">if</span> port_index_out <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;MIDI OUT Device name is incorrect. Please use listed device name.&#34;</span>)
    <span style="color:#66d9ef">if</span> port_index_in <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">or</span> port_index_out <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:
        thread_running <span style="color:#f92672">=</span> False
        midi_ready <span style="color:#f92672">=</span> True
        sys<span style="color:#f92672">.</span>exit()

    midiout<span style="color:#f92672">.</span>open_port(port_index_out)
    in_port_name <span style="color:#f92672">=</span> midiin<span style="color:#f92672">.</span>open_port(port_index_in)

    midi_ready <span style="color:#f92672">=</span> True

    midiin<span style="color:#f92672">.</span>ignore_types(sysex <span style="color:#f92672">=</span> False, timing <span style="color:#f92672">=</span> False, active_sense <span style="color:#f92672">=</span> False)
    midiin<span style="color:#f92672">.</span>set_callback(midi_input_handler(in_port_name))

    <span style="color:#66d9ef">while</span> thread_running:
        <span style="color:#66d9ef">try</span>:
            message <span style="color:#f92672">=</span> midiout_message_queue<span style="color:#f92672">.</span>get(timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.4</span>)
        <span style="color:#66d9ef">except</span> queue<span style="color:#f92672">.</span>Empty:
            <span style="color:#66d9ef">continue</span>
        midiout<span style="color:#f92672">.</span>send_message(message)


<span style="color:#66d9ef">try</span>:
    ser <span style="color:#f92672">=</span> serial<span style="color:#f92672">.</span>Serial(serial_port_name,serial_baud)
    ser<span style="color:#f92672">.</span>setDTR()
<span style="color:#66d9ef">except</span> serial<span style="color:#f92672">.</span>serialutil<span style="color:#f92672">.</span>SerialException:
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Serial port opening error.&#34;</span>)
    midi_watcher()
    sys<span style="color:#f92672">.</span>exit()

ser<span style="color:#f92672">.</span>timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.4</span>

s_watcher <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target <span style="color:#f92672">=</span> serial_watcher)
s_writer <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target <span style="color:#f92672">=</span> serial_writer)
m_watcher <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target <span style="color:#f92672">=</span> midi_watcher)

s_watcher<span style="color:#f92672">.</span>start()
s_writer<span style="color:#f92672">.</span>start()
m_watcher<span style="color:#f92672">.</span>start()

<span style="color:#75715e">#Ctrl-C handler</span>
<span style="color:#66d9ef">try</span>:
    <span style="color:#66d9ef">while</span> True:
        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
<span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Terminating.&#34;</span>)
    thread_running <span style="color:#f92672">=</span> False
    sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)

</code></pre></div><p>In order for this software to work and to communicate between the DAW as well as the serial monitor for my Metro, I had to create new IAP audio inputs and outputs. These are busses that allow for the audio to be channeled later in the DAW.</p>
<p><figure style="flex-grow: 109; flex-basis: 262px">
		<a href="/ps70/posts/wip-final-proj/iap.png" data-size="952x870"><img src="/ps70/posts/wip-final-proj/iap.png"
				srcset="/ps70/posts/wip-final-proj/iap_hu51713f75c615b082285f8b7ffc6c82b8_171107_480x0_resize_box_2.png 480w, /ps70/posts/wip-final-proj/iap_hu51713f75c615b082285f8b7ffc6c82b8_171107_1024x0_resize_box_2.png 1024w"
				width="952"
				height="870"
				loading="lazy"
				alt="IAP">
		</a>
		
		<figcaption>IAP</figcaption>
		
	</figure></p>
<p>I had some trouble getting this to work, however. I kept getting the error that my serial port was unable to open.</p>
<p><figure style="flex-grow: 509; flex-basis: 1223px">
		<a href="/ps70/posts/wip-final-proj/err.png" data-size="1672x328"><img src="/ps70/posts/wip-final-proj/err.png"
				srcset="/ps70/posts/wip-final-proj/err_hu0160ec8d2a12cf82f36633c1e9c94be2_273482_480x0_resize_box_2.png 480w, /ps70/posts/wip-final-proj/err_hu0160ec8d2a12cf82f36633c1e9c94be2_273482_1024x0_resize_box_2.png 1024w"
				width="1672"
				height="328"
				loading="lazy"
				alt="Error">
		</a>
		
		<figcaption>Error</figcaption>
		
	</figure></p>
<p>After trying different debugging methods, such as looking at the code carefully, checking serial monitor output, and other possible issues, I learned from Professor Melenbrink that the issue is that I can&rsquo;t have the serial monitor open in two places (so when the program runs, that counts), which I was reminded of. Then, I plugged my midi button circuit as input to my DAW, Logic Pro, and here is the result!</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe loading="lazy" src="https://www.youtube.com/embed/0X2GHs5goP4" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<h2 id="midi--capacitive-touch">MIDI &amp; Capacitive Touch</h2>
<p>I wrote custom code to measure capacitive touch and turn that data into midi data to use in a DAW!
First, I set up my circuit like so (this is something we went over in earlier weeks):</p>
<p><figure style="flex-grow: 133; flex-basis: 320px">
		<a href="/ps70/posts/wip-final-proj/IMG_7223.jpg" data-size="4032x3024"><img src="/ps70/posts/wip-final-proj/IMG_7223.jpg"
				srcset="/ps70/posts/wip-final-proj/IMG_7223_hu48f193d71a5aac46da188c6e954a6837_2683262_480x0_resize_q75_box.jpg 480w, /ps70/posts/wip-final-proj/IMG_7223_hu48f193d71a5aac46da188c6e954a6837_2683262_1024x0_resize_q75_box.jpg 1024w"
				width="4032"
				height="3024"
				loading="lazy"
				alt="Capacitive sensor">
		</a>
		
		<figcaption>Capacitive sensor</figcaption>
		
	</figure></p>
<p>The idea was that when the sensor outputs beyond a certain threshold, a midi note would be sent as output. When the capacitive sensor is below a certain threshold, the midi note is no longer playing. The capacitive sensor has more flexibility and versatility than the button midi circuit I built last week. This is because copper tape capacitive sensoring is not a binary, but is a function of how much resistance I am putting on the tape! Because of this, I could control velocity of my midi output. (note: velocity in the context of MIDI is a synonym to loudness). I also accounted for this in my code. 127 represents the loudest a midi note can be tagged for. 0 is the smallest. My approach was to first test the range of numbers outputted by the capacitive sensor, and wrote in threshold values according to what was reasonable. For the current setup, I decided to use 40000 as the high threshold, 20000 as a medium threshold, and 1000 as a low threshold. These would in turn represent high, low, and medium velocities, respectfully. These numbers were set to variables so that the threshold values can be easily manipulated based on the sensor sensitivity.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;CapacitiveSensor.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
CapacitiveSensor Sensor <span style="color:#f92672">=</span> CapacitiveSensor(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">5</span>);  <span style="color:#75715e">// 7 is charge pin.  5 is sense pin.
</span><span style="color:#75715e"></span>byte noteON <span style="color:#f92672">=</span> <span style="color:#ae81ff">144</span>; <span style="color:#75715e">//note on command
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">long</span> currentState <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">long</span> lastState <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>(){
  Serial.begin(<span style="color:#ae81ff">115200</span>); <span style="color:#75715e">//initialize Serial connection
</span><span style="color:#75715e"></span>}
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>(){
  <span style="color:#66d9ef">long</span> sensorValue <span style="color:#f92672">=</span> Sensor.capacitiveSensor(<span style="color:#ae81ff">1000</span>);
  <span style="color:#66d9ef">long</span> high <span style="color:#f92672">=</span> <span style="color:#ae81ff">40000</span>;
  <span style="color:#66d9ef">long</span> med <span style="color:#f92672">=</span> <span style="color:#ae81ff">20000</span>;
  <span style="color:#66d9ef">long</span> low <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>;
  currentState <span style="color:#f92672">=</span> sensorValue;
  <span style="color:#66d9ef">if</span> (currentState <span style="color:#f92672">&gt;</span> high  <span style="color:#f92672">&amp;&amp;</span> lastState <span style="color:#f92672">&lt;</span> low){
    MIDImessage(noteON, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">127</span>); <span style="color:#75715e">//turn note 60 on with 127 velocity
</span><span style="color:#75715e"></span>    delay(<span style="color:#ae81ff">200</span>); <span style="color:#75715e">// Debounce
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (currentState <span style="color:#f92672">&gt;</span> med  <span style="color:#f92672">&amp;&amp;</span> (lastState <span style="color:#f92672">&lt;</span> low){
    MIDImessage(noteON, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">80</span>); <span style="color:#75715e">//turn note 60 on with 127 velocity
</span><span style="color:#75715e"></span>    delay(<span style="color:#ae81ff">200</span>); <span style="color:#75715e">// Debounce
</span><span style="color:#75715e"></span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(currentState <span style="color:#f92672">&lt;=</span> high  <span style="color:#f92672">&amp;&amp;</span> lastState <span style="color:#f92672">&gt;=</span> low){
    MIDImessage(noteON, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">0</span>); <span style="color:#75715e">//turn note 60 off
</span><span style="color:#75715e"></span>    delay(<span style="color:#ae81ff">20</span>);
  }
  lastState <span style="color:#f92672">=</span> currentState;

<span style="color:#75715e">//  Serial.println(sensorValue); // Debugging
</span><span style="color:#75715e"></span> 
}
<span style="color:#75715e">//send MIDI message
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> MIDImessage(byte command, byte data1, byte data2) {
  Serial.write(command);
  Serial.write(data1);
  Serial.write(data2);
}
</code></pre></div><p>The serial midi program I ran is the same code as last week&rsquo;s, as well as the IAC buses for input/output. You can find it <a class="link" href="https://juhye-m.github.io/ps70/posts/week-10/"  target="_blank" rel="noopener"
    >here, in week 10</a>.</p>
<p>My circuit and baseline code works. I can test the output values by printing the sensor values to the serial monitor. I ran the serial to midi converter, and hooked it up to my Macbook audio input bus. I then opened my DAW, and it almost works!</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe loading="lazy" src="https://www.youtube.com/embed/wJ-ZqfLPNT8" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>However, for some reason, this midi data doesn&rsquo;t &ldquo;save&rdquo;, nor does it produce sound. However, it is clearly detecting the midi notes. I have yet to debug this.</p>
<h2 id="3d-model">3D Model</h2>
<h2 id="fixing-the-midi-not-saving-issue">Fixing the MIDI not-saving issue</h2>
<p>The issue was that the serial port was outputting values that were too high. That&rsquo;s why it was outputting junk, as shown below.
This problem was address by mapping the values to a certain range. By doing so, the values generated by the capacitive sensor are converted to a better, workable range.
I also made variables for the high and low values in order to abstract some of the code.
I cleaned up and condensed the code as well.</p>
<h2 id="bill-of-materials">Bill Of Materials</h2>
<h4 id="physical-components">Physical components</h4>
<ul>
<li>1 Adafruit Metro Express 0 Board</li>
<li>1 Micro-USB cable</li>
<li>Copper Tape</li>
<li>Electrical tape</li>
<li>Resistor</li>
<li>Connecting wire</li>
<li>3D printed keyboard (optional)</li>
</ul>
<h4 id="virtual-components">Virtual components</h4>
<ul>
<li>1 Digital Audio Workspace (Logic Pro X)</li>
</ul>
<p>You can find the comprehensive bill of mateerials here:</p>
<h2 id="todo">TODO</h2>
<ul>
<li>TCP display</li>
<li>On/Off switch</li>
</ul>

</section>


    <footer class="article-footer">
    

    </footer>

    
</article>

     
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2021 JuHye Mun
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="2.0.1">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>

    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css">

            </main>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"
    integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin="anonymous"></script><script type="text/javascript" src="/ps70/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
